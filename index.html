<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wine Buddy</title>
  <!-- Google fonts for premium typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Theme color for PWA address bar on mobile -->
  <meta name="theme-color" content="#61101f">
  <style>
    :root {
      /* Rich wine colour palette */
      --wine-900: #2c0510;
      --wine-800: #450a18;
      --wine-700: #61101f;
      --wine-600: #7a1425;
      --wine-500: #8f182b;
      --wine-400: #a9193a;
      --wine-300: #c33d55;
      --wine-200: #da7a8a;
      --wine-100: #f5e6ea;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at 50% 20%, var(--wine-700), var(--wine-900));
      color: var(--wine-100);
      min-height: 100vh;
    }
    /* Global container for consistent horizontal padding */
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
    }
    /* Header / Top bar */
    header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.3);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-left img {
      height: 32px;
      width: 32px;
      object-fit: contain;
    }
    .header-left .app-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }
    /* Hero section */
    .hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 2rem 0 1.5rem;
    }
    .hero-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 0.5rem;
    }
    .hero-headline {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }
    .hero-subheadline {
      font-size: 0.95rem;
      font-weight: 400;
      color: var(--wine-200);
      max-width: 480px;
      line-height: 1.4;
    }
    /* Stats cards */
    .stats-row {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .stat-card {
      flex: 1;
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      position: relative;
      overflow: hidden;
    }
    .stat-icon {
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-icon svg {
      width: 24px;
      height: 24px;
      stroke: #ffffff;
      stroke-width: 1.8;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .stat-number {
      font-size: 2.2rem;
      font-weight: 700;
    }
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--wine-200);
      letter-spacing: 0.05em;
    }
    /* Action cards */
    .action-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 2rem;
    }
    .action-card {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .action-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-icon svg {
      width: 28px;
      height: 28px;
      stroke: #ffffff;
      stroke-width: 1.8;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .action-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .action-desc {
      font-size: 0.8rem;
      color: var(--wine-200);
    }
    /* Form panel styling */
    .form-panel {
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      margin-top: 1rem;
    }
    .form-panel .section {
      margin-bottom: 1.5rem;
    }
    .form-panel .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      padding-bottom: 0.3rem;
    }
    .form-panel .field {
      margin-bottom: 1rem;
      text-align: left;
    }
    .form-panel label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
      color: var(--wine-200);
    }
    .form-panel input,
    .form-panel select,
    .form-panel textarea {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: none;
      background: #150910;
      color: var(--wine-100);
      box-shadow: inset 0 0 0 1px #4a0915;
      font-size: 0.95rem;
    }
    .form-panel input::placeholder,
    .form-panel textarea::placeholder {
      color: #987;
    }
    /* Chips for smell/taste */
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .chip {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.1);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .chip.selected {
      background: var(--wine-500);
    }
    /* Form buttons */
    .form-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    .btn {
      width: 100%;
      padding: 0.9rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary {
      background: var(--wine-500);
      color: white;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--wine-200);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    /* Toast message */
    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--wine-500);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 100;
    }

    /* Overlay for library and stats */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      overflow-y: auto;
      display: none;
    }
    .panel {
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      margin: 4rem auto 2rem;
      max-width: 600px;
      color: var(--wine-100);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .panel-title {
      font-size: 1.3rem;
      font-weight: 600;
    }
    .panel-close {
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 0.4rem;
      transition: background 0.2s ease;
    }
    .panel-close:hover {
      background: rgba(255,255,255,0.1);
    }
    .panel-search {
      margin-bottom: 1rem;
    }
    .panel-search input {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: none;
      background: #150910;
      color: var(--wine-100);
      box-shadow: inset 0 0 0 1px #4a0915;
      font-size: 0.9rem;
    }
    .panel-list {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    .library-item {
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 0.8rem;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .library-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.5);
    }
    .library-grape {
      font-size: 1rem;
      font-weight: 600;
    }
    .library-count {
      font-size: 0.8rem;
      color: var(--wine-200);
    }
    .empty {
      color: var(--wine-200);
      text-align: center;
      margin-top: 1rem;
    }
    .tasting-entry {
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 0.8rem;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    .entry-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    /* Make tasting entry rows match stat cards styling */
    .tasting-entry .entry-row:not(:last-child) {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .tasting-entry .entry-row:nth-child(odd) {
      background: rgba(255,255,255,0.04);
    }
    .entry-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--wine-200);
      min-width: 80px;
    }
    .entry-value {
      font-size: 0.9rem;
      flex: 1;
      text-align: left;
    }
    .entry-actions {
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Small buttons for increment/decrement/edit/delete */
    .small-btn {
      background: var(--wine-400);
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.4rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .small-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .small-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    /* Stats cards for detailed stats page */
    .stats-category-card {
      width: 100%;
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    .stats-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .stats-category-card .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 0.9rem;
    }
    .stats-category-card .stat-row:not(:last-child) {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .stats-category-card .stat-row:nth-child(odd) {
      background: rgba(255,255,255,0.04);
    }
    .stats-category-card .stat-name {
      flex: 1;
      text-align: left;
    }
    .stats-category-card .stat-value {
      flex-shrink: 1;
      text-align: right;
      margin-left: 1rem;
      /* Allow long lists to wrap within the card */
      white-space: normal;
      word-break: break-word;
    }

    /* Categories for aroma/taste selection */
    .category {
      margin-bottom: 0.6rem;
    }
    .category-header {
      width: 100%;
      padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.08);
      border-radius: 0.6rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--wine-100);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s ease;
    }
    .category-header.open {
      background: var(--wine-600);
    }
    .category-items {
      display: none;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }
    .category-items.open {
      display: flex;
    }
    .category-items .chip {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.1);
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .category-items .chip.selected {
      background: var(--wine-500);
    }

    /* Custom colour dropdown with swatch rectangles */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }
    .custom-selected {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      background: #150910;
      color: var(--wine-100);
      box-shadow: inset 0 0 0 1px #4a0915;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      user-select: none;
    }
    .custom-selected .color-swatch {
      width: 2.4rem;
      height: 1.4rem;
      border-radius: 0.3rem;
    }
    .custom-options {
      position: absolute;
      top: calc(100% + 0.3rem);
      left: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 0.6rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6);
      z-index: 400;
    }
    .custom-option {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .custom-option:hover {
      background: rgba(255,255,255,0.1);
    }
    .custom-option .color-swatch {
      width: 2.4rem;
      height: 1.4rem;
      border-radius: 0.3rem;
    }

    /* Descriptor groups for smell/taste */
    .descriptor-group {
      display: inline-block;
      margin-right: 0.4rem;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- Top bar / Header -->
  <header>
    <div class="header-left">
      <img src="logo.png" alt="Wine Buddy logo">
      <span class="app-name">Wine Buddy</span>
    </div>
    <div class="header-right">
      <!-- Placeholder for future profile/settings -->
      <span class="header-icon">☰</span>
    </div>
  </header>

  <main class="container" id="main">
    <!-- Hero Section -->
    <section class="hero">
      <img src="logo.png" alt="Wine Buddy logo" class="hero-logo">
      <h2 class="hero-headline">Discover your wine palate.</h2>
      <p class="hero-subheadline">Record tastings, track your favorite grapes, and explore your unique flavor patterns.</p>
    </section>

    <!-- Paused tasting section (hidden when none) -->
    <div id="pausedContainer" style="display:none; margin-top: 1rem;"></div>

    <!-- Stats Cards -->
    <section class="stats-row">
      <div class="stat-card" id="stat-tastings">
        <div class="stat-icon">
          <!-- Wine glass outline icon -->
          <svg viewBox="0 0 24 24">
            <path d="M8 2h8l-1 6c0 2.5-2 4.5-4 4.5s-4-2-4-4.5l-1-6z" />
            <line x1="12" y1="12.5" x2="12" y2="20" />
            <line x1="9" y1="20" x2="15" y2="20" />
          </svg>
        </div>
        <div class="stat-number" id="tastingCount">0</div>
        <div class="stat-label">Tastings</div>
      </div>
      <div class="stat-card" id="stat-grapes">
        <div class="stat-icon">
          <!-- Grape cluster icon -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="7" r="3" />
            <circle cx="9" cy="12" r="3" />
            <circle cx="15" cy="12" r="3" />
            <circle cx="12" cy="17" r="3" />
          </svg>
        </div>
        <div class="stat-number" id="grapeCount">0</div>
        <div class="stat-label">Grapes</div>
      </div>
    </section>

    <!-- Action Cards -->
    <section class="action-list">
      <div class="action-card" id="newTastingBtn">
        <div class="action-icon">
          <!-- Plus in circle icon -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9" />
            <line x1="12" y1="8" x2="12" y2="16" />
            <line x1="8" y1="12" x2="16" y2="12" />
          </svg>
        </div>
        <div>
          <div class="action-title">New Tasting</div>
          <div class="action-desc">Start a new wine entry</div>
        </div>
      </div>
      <div class="action-card" id="libraryBtn">
        <div class="action-icon">
          <!-- List icon -->
          <svg viewBox="0 0 24 24">
            <line x1="9" y1="6" x2="20" y2="6" />
            <line x1="9" y1="12" x2="20" y2="12" />
            <line x1="9" y1="18" x2="20" y2="18" />
            <circle cx="5" cy="6" r="1.2" />
            <circle cx="5" cy="12" r="1.2" />
            <circle cx="5" cy="18" r="1.2" />
          </svg>
        </div>
        <div>
          <div class="action-title">Tasting Library</div>
          <div class="action-desc">Browse all your tastings</div>
        </div>
      </div>
      <div class="action-card" id="statsBtn">
        <div class="action-icon">
          <!-- Trend line icon -->
          <svg viewBox="0 0 24 24">
            <polyline points="4 16 9 11 14 14 20 6" />
            <circle cx="4" cy="16" r="1.2" />
            <circle cx="9" cy="11" r="1.2" />
            <circle cx="14" cy="14" r="1.2" />
            <circle cx="20" cy="6" r="1.2" />
          </svg>
        </div>
        <div>
          <div class="action-title">Detailed Stats</div>
          <div class="action-desc">See your palate stats</div>
        </div>
      </div>
      <!-- Insights card for palate map and blind spots -->
      <div class="action-card" id="insightsBtn">
        <div class="action-icon">
          <!-- Star icon representing insights -->
          <svg viewBox="0 0 24 24">
            <polygon points="12 2 14.5 8.5 21 9 16 13 17.5 19.5 12 16 6.5 19.5 8 13 3 9 9.5 8.5 12 2"/>
          </svg>
        </div>
        <div>
          <div class="action-title">Insights</div>
          <div class="action-desc">Palate map & blind spots</div>
        </div>
      </div>
    </section>

    <!-- New Tasting Form (hidden by default) -->
    <section id="newTastingSection" style="display:none;">
      <div class="form-panel">
        <h3 style="margin-top:0; margin-bottom:1rem; font-size:1.2rem; font-weight:600;">New Tasting</h3>
        <!-- Basic Info -->
        <div class="section">
          <div class="section-title">Basic Info</div>
          <div class="field">
            <label for="vineyard">Vineyard / Winery</label>
            <input type="text" id="vineyard" placeholder="Enter winery name" />
          </div>
          <div class="field">
            <label for="wineName">Wine Name</label>
            <input type="text" id="wineName" placeholder="Enter wine name" />
          </div>
          <div class="field">
            <label for="vintage">Vintage Year</label>
            <input type="number" id="vintage" placeholder="e.g., 2021" />
          </div>
          <div class="field">
            <label for="grape">Grape Variety</label>
            <select id="grape">
              <!-- Grape options will be populated by script -->
            </select>
          </div>
        </div>
        <!-- Profile -->
        <div class="section">
          <div class="section-title">Profile</div>
          <div class="field">
            <label for="sweetness">Sweetness</label>
            <select id="sweetness">
              <option value="">-- Select --</option>
              <option value="Dry">Dry</option>
              <option value="Off-Dry">Off-Dry</option>
              <option value="Medium-Dry">Medium-Dry</option>
              <option value="Medium-Sweet">Medium-Sweet</option>
              <option value="Sweet">Sweet</option>
              <option value="Luscious">Luscious</option>
            </select>
          </div>
          <div class="field">
            <label for="acidity">Acidity</label>
            <select id="acidity">
              <option value="">-- Select --</option>
              <option value="Low">Low</option>
              <option value="Medium(-)">Medium(-)</option>
              <option value="Medium">Medium</option>
              <option value="Medium(+)">Medium(+)</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <!-- Aromas & Flavors -->
        <div class="section">
          <div class="section-title">Aromas</div>
          <!-- Category buttons for aromas will be populated via JS -->
          <div id="aromaCategories"></div>
        </div>
        <div class="section">
          <div class="section-title">Taste</div>
          <!-- Category buttons for taste will be populated via JS -->
          <div id="tasteCategories"></div>
        </div>
        <div class="section">
          <div class="section-title">Colour</div>
          <div class="field">
            <label>Colour Type</label>
            <!-- Custom dropdown with color rectangles -->
            <div class="custom-dropdown" id="colourTypeDropdown">
              <div class="custom-selected" id="colourTypeSelected">-- Select --</div>
              <div class="custom-options" id="colourTypeOptions" style="display:none;"></div>
            </div>
            <!-- Hidden select to store the value -->
            <select id="colourType" style="display:none">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="field">
            <label for="colourIntensity">Colour Intensity</label>
            <select id="colourIntensity">
              <option value="">-- Select --</option>
              <option value="Light">Light</option>
              <option value="Medium">Medium</option>
              <option value="Deep">Deep</option>
            </select>
          </div>
        </div>
        <!-- Ratings (moved below Colour to just above Additional notes) -->
        <div class="section">
          <div class="section-title">Ratings <span style="font-size:0.75rem; font-weight:400; color: var(--wine-200);">(Optional)</span></div>
          <div class="field">
            <label for="wineRating">Wine Rating (1–10)</label>
            <select id="wineRating">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="field">
            <label for="wineryRating">Winery Rating (1–10)</label>
            <select id="wineryRating">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="field">
            <label for="grapeRating">Grape Rating (1–10)</label>
            <select id="grapeRating">
              <option value="">-- Select --</option>
            </select>
          </div>
        </div>
        <!-- Additional notes -->
        <div class="section">
          <div class="section-title">Additional Notes</div>
          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" rows="3" placeholder="Write any tasting notes..."></textarea>
          </div>
        </div>
        <!-- Form Buttons -->
        <div class="form-buttons">
          <button class="btn btn-primary" id="saveBtn">Save Tasting</button>
          <button class="btn btn-secondary" id="pauseBtn">Pause</button>
          <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Tasting saved!</div>

  <!-- Overlay for Library and Stats -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="overlayContent" class="panel"></div>
  </div>

  <script src="localStorage.js"></script>
  <script>
    // Global state for editing and paused entries
    let editIndex = null;
    // Helper to update paused entry UI on the landing page
    function updatePausedUI() {
      const pausedData = localStorage.getItem('winebuddy_paused');
      const pausedContainer = document.getElementById('pausedContainer');
      if (!pausedContainer) return;
      if (pausedData) {
        const paused = JSON.parse(pausedData);
        // Show paused card with simple info
        pausedContainer.style.display = 'block';
        pausedContainer.innerHTML = `<div class="action-card" id="resumePausedBtn">
          <div class="action-icon">
            <!-- Pause icon -->
            <svg viewBox="0 0 24 24"><line x1="8" y1="5" x2="8" y2="19"/><line x1="16" y1="5" x2="16" y2="19"/></svg>
          </div>
          <div><div class="action-title">Resume Paused Tasting</div><div class="action-desc">${paused.wineName || 'Unfinished entry'}</div></div>
        </div>`;
        document.getElementById('resumePausedBtn').addEventListener('click', () => {
          resumePaused();
        });
      } else {
        pausedContainer.style.display = 'none';
        pausedContainer.innerHTML = '';
      }
    }
    // Resume a paused tasting: pre-fill form and remove paused flag
    function resumePaused() {
      const pausedData = localStorage.getItem('winebuddy_paused');
      if (!pausedData) return;
      const p = JSON.parse(pausedData);
      // Set editIndex to null to treat as new tasting
      editIndex = null;
      // Pre-fill fields
      document.getElementById('vineyard').value = p.vineyard || '';
      document.getElementById('wineName').value = p.wineName || '';
      document.getElementById('vintage').value = p.vintage || '';
      document.getElementById('grape').value = p.grape || '';
      document.getElementById('wineRating').value = p.wineRating || '';
      document.getElementById('wineryRating').value = p.wineryRating || '';
      document.getElementById('grapeRating').value = p.grapeRating || '';
      document.getElementById('sweetness').value = p.sweetness || '';
      document.getElementById('acidity').value = p.acidity || '';
      // Set colour using custom dropdown helper
      setColourSelection(p.colour || '');
      document.getElementById('colourIntensity').value = p.intensity || '';
      document.getElementById('notes').value = p.notes || '';
      // Set selected aromas and taste from paused draft
      selectedAromas = (p.smell || []).slice();
      selectedTastes = (p.taste || []).slice();
      setSelectionsForSection('aromaCategories', selectedAromas);
      setSelectionsForSection('tasteCategories', selectedTastes);
      // Remove paused from storage
      localStorage.removeItem('winebuddy_paused');
      updatePausedUI();
      // Show form
      newTastingSection.style.display = 'block';
      window.scrollTo({ top: newTastingSection.offsetTop - 80, behavior: 'smooth' });
    }
    // Data arrays for grapes, smell, and taste notes (alphabetical)
    const grapes = [
      'Cabernet Sauvignon',
      'Merlot',
      'Pinot Noir / Pinot Nero / Spätburgunder',
      'Syrah / Shiraz',
      'Grenache / Garnacha / Cannonau',
      'Tempranillo / Tinta Roriz / Aragonez',
      'Sangiovese',
      'Malbec / Côt',
      'Cabernet Franc',
      'Zinfandel / Primitivo',
      'Nebbiolo',
      'Barbera',
      'Gamay',
      'Mourvèdre / Monastrell / Mataro',
      'Carignan / Mazuelo / Cariñena',
      'Petit Verdot',
      'Pinotage',
      'Touriga Nacional',
      'Aglianico',
      'Corvina',
      'Dolcetto',
      'Nero d\'Avola',
      'Tannat',
      'Blaufränkisch / Lemberger / Kékfrankos',
      'Carmenère',
      'Mencía',
      'Montepulciano',
      'Sagrantino',
      'Lagrein',
      'Frappato',
      'Bonarda (Argentinian / Douce Noir)',
      'Refosco',
      'Graciano',
      'Xinomavro',
      'Schiava / Trollinger / Vernatsch',
      'Pinot Meunier',
      'Negroamaro',
      'Saperavi',
      'Petite Sirah / Durif',
      'Counoise',
      'Cinsault / Cinsaut',
      'Teroldego',
      'Lambrusco (Grasparossa / Sorbara / Salamino)',
      'Zweigelt',
      'Saint Laurent',
      'Kadarka',
      'Colorino',
      'Pelaverga',
      'País / Mission / Criolla',
      'Touriga Franca',
      'Castelão / Periquita',
      'Bobal',
      'Nielluccio (Corsican Sangiovese)',
      'Alicante Bouschet',
      'Braucol / Fer Servadou',
      'Mondeuse Noire',
      'Marzemino',
      'Cesanese',
      'Grolleau Noir',
      'Mourisco Tinto',
      'Nero di Troia / Uva di Troia',
      'Primitivo di Manduria (style)',
      'Cabernet Dorsa',
      'Corvinone',
      'Negrette / Négrette',
      'Pinot Noir Précoce / Frühburgunder',
      'Nerello Mascalese',
      'Nerello Cappuccio',
      'Plavac Mali',
      'Mavrud',
      'Chardonnay',
      'Sauvignon Blanc',
      'Pinot Gris / Pinot Grigio / Grauburgunder',
      'Riesling',
      'Gewürztraminer / Traminer Aromatico',
      'Viognier',
      'Sémillon',
      'Chenin Blanc',
      'Albariño / Alvarinho',
      'Verdejo',
      'Trebbiano / Ugni Blanc',
      'Garganega',
      'Fiano',
      'Greco',
      'Verdicchio',
      'Cortese',
      'Pecorino',
      'Moscato Bianco / Muscat Blanc à Petits Grains',
      'Torrontés',
      'Palomino Fino',
      'Pedro Ximénez',
      'Airén',
      'Macabeo / Viura',
      'Parellada',
      'Xarel-lo',
      'Grüner Veltliner',
      'Müller-Thurgau',
      'Silvaner',
      'Rkatsiteli',
      'Assyrtiko',
      'Bordeaux Red Blend',
      'Bordeaux White Blend',
      'GSM / Southern Rhône Red Blend',
      'Champagne / Traditional Method Sparkling Blend',
      'Super Tuscan Red Blend'
    ];
    const smellOptions = [
      // Updated smell list (will also be used for taste)
      'Acacia',
      'Almond',
      'Apple',
      'Apricot',
      'Banana',
      'Bark',
      'Black Cherry',
      'Black Pepper',
      'Black Plum',
      'Blackberry',
      'Blackcurrant',
      'Butter',
      'Caramel',
      'Cedar',
      'Cinnamon',
      'Citrus: Lemon',
      'Citrus: Lime',
      'Clove',
      'Cranberry',
      'Dried Fruit',
      'Earthy',
      'Elderflower',
      'Forest Floor',
      'Grapefruit',
      'Grass',
      'Hazelnut',
      'Honey',
      'Honeysuckle',
      'Jasmine',
      'Lavender',
      'Leather',
      'Lemon Zest',
      'Mango',
      'Mint',
      'Mushroom',
      'Nutmeg',
      'Nutty',
      'Orange',
      'Orange Peel',
      'Passion Fruit',
      'Peach',
      'Nectarine',
      'Pear',
      'Pineapple',
      'Raspberry',
      'Red Cherry',
      'Red Plum',
      'Rose',
      'Stone',
      'Strawberry',
      'Tobacco',
      'Vanilla',
      'Violet',
      'Wet Leaves',
      'Smokey'
    ];
    const tasteOptions = [...smellOptions];

    // Colour options in order from darkest to lightest with approximate hex values for wine colours
    const colourOptions = [
      { value: 'Mahogany', label: 'Mahogany', color: '#4b2e22' },
      { value: 'Tawny', label: 'Tawny', color: '#7a432b' },
      { value: 'Garnet', label: 'Garnet', color: '#7b1f2e' },
      { value: 'Ruby', label: 'Ruby', color: '#8d0a23' },
      { value: 'Purple', label: 'Purple', color: '#571b49' },
      { value: 'Copper', label: 'Copper', color: '#b87333' },
      { value: 'Amber', label: 'Amber', color: '#bf7300' },
      { value: 'Gold', label: 'Gold', color: '#d5a300' },
      { value: 'Salmon', label: 'Salmon', color: '#d1697a' },
      { value: 'Pink', label: 'Pink', color: '#e89cb8' },
      { value: 'Lemon', label: 'Lemon', color: '#f2d94e' },
      { value: 'Lemon-Green', label: 'Lemon-Green', color: '#c4e538' }
    ];

    // Category lists for aromas and taste
    const categories = [
      {
        name: 'Red Fruits',
        items: ['Cranberry','Raspberry','Red Cherry','Strawberry','Red Plum']
      },
      {
        name: 'Dark Fruits',
        items: ['Blackcurrant','Black Plum','Blackberry','Black Cherry','Fig','Blueberry']
      },
      {
        name: 'Citrus Fruits',
        items: ['Lemon','Lime','Grapefruit','Lemon Zest','Orange','Orange Peel','Pineapple']
      },
      {
        name: 'Other Fruits',
        items: ['Apricot','Apple','Banana','Mango','Nectarine','Peach','Pear','Passion Fruit']
      },
      {
        name: 'Earthy / Vegetal',
        items: ['Bark','Forest Floor','Grass','Mint','Mushroom','Stone','Tobacco','Wet Leaves','Earthy']
      },
      {
        name: 'Floral',
        items: ['Acacia','Elderflower','Honeysuckle','Jasmine','Lavender','Rose','Violet']
      },
      {
        name: 'Spices/Nuts',
        items: ['Cinnamon','Clove','Nutmeg','Almond','Hazelnut','Nutty','Oregano']
      },
      {
        name: 'Sweet / Other',
        items: ['Butter','Caramel','Honey','Vanilla','Smokey','Leather']
      }
    ];

    // Selected descriptors for aromas and taste
    let selectedAromas = [];
    let selectedTastes = [];
    // Populate grape and rating selects
    const grapeSelect = document.getElementById('grape');
    grapes.sort().forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      grapeSelect.appendChild(opt);
    });
    function populateRatingSelect(id) {
      const sel = document.getElementById(id);
      for (let i=1; i<=10; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        sel.appendChild(opt);
      }
    }

    // Create collapsible category lists for aromas and taste
    function createCategoryLists(containerId, categoryList, selectedList) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      categoryList.forEach(cat => {
        const catDiv = document.createElement('div');
        catDiv.className = 'category';
        // Header
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = cat.name;
        // Items container
        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'category-items';
        cat.items.forEach(item => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = item;
          // Mark selected if previously selected
          if (selectedList.includes(item)) {
            chip.classList.add('selected');
          }
          chip.addEventListener('click', (e) => {
            e.stopPropagation();
            if (chip.classList.contains('selected')) {
              chip.classList.remove('selected');
              const idx = selectedList.indexOf(item);
              if (idx >= 0) selectedList.splice(idx, 1);
            } else {
              if (selectedList.length < 4) {
                chip.classList.add('selected');
                selectedList.push(item);
              }
            }
          });
          itemsDiv.appendChild(chip);
        });
        catDiv.appendChild(header);
        catDiv.appendChild(itemsDiv);
        // Header click to toggle
        header.addEventListener('click', () => {
          const isOpen = header.classList.contains('open');
          // Close all headers in this container
          container.querySelectorAll('.category-header').forEach(h => h.classList.remove('open'));
          container.querySelectorAll('.category-items').forEach(div => div.classList.remove('open'));
          if (!isOpen) {
            header.classList.add('open');
            itemsDiv.classList.add('open');
          }
        });
        container.appendChild(catDiv);
      });
    }

    // Set selections for a section (used when editing or resuming)
    function setSelectionsForSection(containerId, selectedList) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.querySelectorAll('.category-items .chip').forEach(chip => {
        if (selectedList.includes(chip.textContent)) {
          chip.classList.add('selected');
        } else {
          chip.classList.remove('selected');
        }
      });
    }
    populateRatingSelect('wineRating');
    populateRatingSelect('wineryRating');
    populateRatingSelect('grapeRating');
    // Populate smell and taste chips
    function createChips(containerId, options) {
      const container = document.getElementById(containerId);
      options.sort().forEach(item => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = item;
        chip.addEventListener('click', () => {
          // Toggle selection; limit to 4 chips
          const selected = [...container.querySelectorAll('.chip.selected')];
          if (chip.classList.contains('selected')) {
            chip.classList.remove('selected');
          } else if (selected.length < 4) {
            chip.classList.add('selected');
          }
        });
        container.appendChild(chip);
      });
    }
    // Build categories for aromas and taste selection
    createCategoryLists('aromaCategories', categories, selectedAromas);
    createCategoryLists('tasteCategories', categories, selectedTastes);

    // Initialise custom colour dropdown
    function initColourDropdown() {
      const dropdown = document.getElementById('colourTypeDropdown');
      const selectedEl = document.getElementById('colourTypeSelected');
      const optionsEl = document.getElementById('colourTypeOptions');
      const hiddenSelect = document.getElementById('colourType');
      if (!dropdown || !selectedEl || !optionsEl || !hiddenSelect) return;
      // Build options list
      optionsEl.innerHTML = '';
      colourOptions.forEach(opt => {
        const optDiv = document.createElement('div');
        optDiv.className = 'custom-option';
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = opt.color;
        const label = document.createElement('span');
        label.textContent = opt.label;
        optDiv.appendChild(swatch);
        optDiv.appendChild(label);
        optDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          setColourSelection(opt.value);
          optionsEl.style.display = 'none';
        });
        optionsEl.appendChild(optDiv);
      });
      // Populate hidden select
      hiddenSelect.innerHTML = '<option value="">-- Select --</option>';
      colourOptions.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        hiddenSelect.appendChild(option);
      });
      // Toggle dropdown on click
      selectedEl.addEventListener('click', (e) => {
        e.stopPropagation();
        optionsEl.style.display = optionsEl.style.display === 'block' ? 'none' : 'block';
      });
      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          optionsEl.style.display = 'none';
        }
      });
      // Initialise selected display to placeholder
      setColourSelection(hiddenSelect.value);
    }
    // Set selected colour programmatically
    function setColourSelection(value) {
      const hiddenSelect = document.getElementById('colourType');
      const selectedEl = document.getElementById('colourTypeSelected');
      hiddenSelect.value = value || '';
      // Find matching option
      const opt = colourOptions.find(o => o.value === value);
      if (opt) {
        selectedEl.innerHTML = `<div class="color-swatch" style="background:${opt.color}"></div><span>${opt.label}</span>`;
      } else {
        selectedEl.innerHTML = '-- Select --';
      }
    }

    // Example counters; replace these with actual data if storing tastings
    let tastings = getTastings();
    function updateStats() {
      // Refresh tastings from localStorage each time stats are updated
      tastings = getTastings();
      const tastingCount = tastings.length;
      const grapeCount = new Set(tastings.map(t => t.grape)).size;
      animateNumber('tastingCount', tastingCount);
      animateNumber('grapeCount', grapeCount);
    }
    function animateNumber(id, target) {
      const el = document.getElementById(id);
      const duration = 800;
      const startTime = performance.now();
      function step(currentTime) {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = Math.floor(progress * target);
        el.textContent = value;
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    // Show/hide New Tasting section
    const newTastingBtn = document.getElementById('newTastingBtn');
    const newTastingSection = document.getElementById('newTastingSection');
    const cancelBtn = document.getElementById('cancelBtn');
    newTastingBtn.addEventListener('click', () => {
      newTastingSection.style.display = 'block';
      window.scrollTo({ top: newTastingSection.offsetTop - 80, behavior: 'smooth' });
    });
    cancelBtn.addEventListener('click', () => {
      newTastingSection.style.display = 'none';
      document.getElementById('vineyard').value = '';
      document.getElementById('wineName').value = '';
      document.getElementById('vintage').value = '';
      document.getElementById('grape').selectedIndex = 0;
      document.getElementById('wineRating').selectedIndex = 0;
      document.getElementById('wineryRating').selectedIndex = 0;
      document.getElementById('grapeRating').selectedIndex = 0;
      document.getElementById('sweetness').selectedIndex = 0;
      document.getElementById('acidity').selectedIndex = 0;
      document.getElementById('colourType').selectedIndex = 0;
      // Reset custom colour selection display
      setColourSelection('');
      document.getElementById('colourIntensity').selectedIndex = 0;
      document.getElementById('notes').value = '';
      // Reset selections for aromas and taste
      selectedAromas = [];
      selectedTastes = [];
      // Remove selected class from all chips
      document.querySelectorAll('.category-items .chip.selected').forEach(chip => chip.classList.remove('selected'));
      // Collapse any open category lists
      document.querySelectorAll('.category-header.open').forEach(h => h.classList.remove('open'));
      document.querySelectorAll('.category-items.open').forEach(div => div.classList.remove('open'));
      // Reset editing state and save button label
      editIndex = null;
      const saveBtnReset = document.getElementById('saveBtn');
      if (saveBtnReset) saveBtnReset.textContent = 'Save Tasting';
    });
    // Unified save button handler (new or update)
    document.getElementById('saveBtn').addEventListener('click', () => {
      // Determine if editing or new entry
      const tData = {
        vineyard: document.getElementById('vineyard').value.trim(),
        wineName: document.getElementById('wineName').value.trim(),
        vintage: document.getElementById('vintage').value.trim(),
        grape: document.getElementById('grape').value,
        wineRating: document.getElementById('wineRating').value,
        wineryRating: document.getElementById('wineryRating').value,
        grapeRating: document.getElementById('grapeRating').value,
        sweetness: document.getElementById('sweetness').value,
        acidity: document.getElementById('acidity').value,
        smell: selectedAromas.slice(),
        taste: selectedTastes.slice(),
        colour: document.getElementById('colourType').value,
        intensity: document.getElementById('colourIntensity').value,
        notes: document.getElementById('notes').value.trim()
      };
      // If editing existing tasting
      if (editIndex !== null && editIndex >= 0 && editIndex < tastings.length) {
        const existing = tastings[editIndex];
        Object.assign(existing, tData);
        existing.updatedAt = new Date().toISOString();
        // Save updated list
        saveTastings(tastings);
        editIndex = null;
        // Reset button text
        document.getElementById('saveBtn').textContent = 'Save Tasting';
      } else {
        // New tasting
        const newTasting = Object.assign({}, tData, {
          createdAt: new Date().toISOString(),
          timesBought: 1
        });
        addTasting(newTasting);
        tastings = getTastings();
      }
      // Remove any paused entry since final save overrides pause
      localStorage.removeItem('winebuddy_paused');
      updatePausedUI();
      // Reset form and hide
      cancelBtn.click();
      // Update stats
      updateStats();
      // Show toast
      const toast = document.getElementById('toast');
      toast.textContent = 'Tasting saved!';
      toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, 2000);
    });

    // Pause button handler: save current draft to localStorage and hide form
    document.getElementById('pauseBtn').addEventListener('click', () => {
      // Collect current form state
      const draft = {
        vineyard: document.getElementById('vineyard').value.trim(),
        wineName: document.getElementById('wineName').value.trim(),
        vintage: document.getElementById('vintage').value.trim(),
        grape: document.getElementById('grape').value,
        wineRating: document.getElementById('wineRating').value,
        wineryRating: document.getElementById('wineryRating').value,
        grapeRating: document.getElementById('grapeRating').value,
        sweetness: document.getElementById('sweetness').value,
        acidity: document.getElementById('acidity').value,
        smell: selectedAromas.slice(),
        taste: selectedTastes.slice(),
        colour: document.getElementById('colourType').value,
        intensity: document.getElementById('colourIntensity').value,
        notes: document.getElementById('notes').value.trim(),
      };
      // Store draft
      localStorage.setItem('winebuddy_paused', JSON.stringify(draft));
      // Update paused UI
      updatePausedUI();
      // Hide form and reset editing state
      cancelBtn.click();
      // Show toast message
      const toast = document.getElementById('toast');
      toast.textContent = 'Tasting paused!';
      toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, 2000);
    });
    // Initialize counters
    updateStats();
    // Initialize paused tasting UI
    updatePausedUI();
    // Initialize custom colour dropdown
    initColourDropdown();

    /* ------------------------------ Library & Stats Overlay ------------------------------ */
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlayContent');
    // Show overlay with provided HTML content
    function showOverlay(html) {
      overlayContent.innerHTML = html;
      overlay.style.display = 'block';
    }
    // Close overlay
    function closeOverlay() {
      overlay.style.display = 'none';
      overlayContent.innerHTML = '';
    }
    // Close overlay when clicking on backdrop
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        closeOverlay();
      }
    });
    // Library button
    document.getElementById('libraryBtn').addEventListener('click', () => {
      showLibrary();
    });
    // Stats button
    document.getElementById('statsBtn').addEventListener('click', () => {
      showStats();
    });

    // Insights button
    document.getElementById('insightsBtn').addEventListener('click', () => {
      showInsights();
    });

    // Show the Tasting Library
    function showLibrary() {
      // Refresh tastings from localStorage
      tastings = getTastings();
      // Create search and list of grapes
      const grapeCounts = {};
      tastings.forEach((t, idx) => {
        if (!grapeCounts[t.grape]) grapeCounts[t.grape] = 0;
        grapeCounts[t.grape]++;
      });
      const grapesList = Object.keys(grapeCounts).sort();
      let listHtml = '';
      grapesList.forEach(g => {
        const count = grapeCounts[g];
        listHtml += `<div class="library-item" data-grape="${g}">\n`
          + `<div class="library-grape">${g}</div>`
          + `<div class="library-count">${count} tasting${count !== 1 ? 's' : ''}</div>`
          + `</div>`;
      });
      const html = `
        <div class="panel-header">
          <div class="panel-title">Tasting Library</div>
          <div class="panel-close" id="libraryClose">✕</div>
        </div>
        <div class="panel-search">
          <input type="text" id="librarySearch" placeholder="Search grapes..." />
        </div>
        <div id="libraryList" class="panel-list">${listHtml || '<p class="empty">No tastings yet.</p>'}</div>
      `;
      showOverlay(html);
      // Close
      document.getElementById('libraryClose').addEventListener('click', closeOverlay);
      const searchInput = document.getElementById('librarySearch');
      const listEl = document.getElementById('libraryList');
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.toLowerCase();
        [...listEl.children].forEach(item => {
          const g = item.getAttribute('data-grape').toLowerCase();
          item.style.display = g.includes(q) ? '' : 'none';
        });
      });
      // Click on grape item
      listEl.addEventListener('click', (e) => {
        const item = e.target.closest('.library-item');
        if (!item) return;
        const grape = item.getAttribute('data-grape');
        showGrapeDetail(grape);
      });
    }

    function showGrapeDetail(grape) {
      // Refresh tastings from localStorage
      tastings = getTastings();
      // Filter tastings by grape
      const tasts = tastings.map((t, idx) => ({ ...t, index: idx }))
        .filter(t => t.grape === grape);
      // Compute common notes if count >= 3
      let commonHtml = '';
      if (tasts.length >= 3) {
        function topItems(arrays) {
          const freq = {};
          arrays.forEach(list => list.forEach(item => {
            const key = item.toLowerCase();
            freq[key] = (freq[key] || 0) + 1;
          }));
          const sorted = Object.entries(freq).sort((a,b) => b[1]-a[1]);
          return sorted.filter(([k,v]) => v > 1).slice(0,5).map(([k,v]) => k.charAt(0).toUpperCase() + k.slice(1));
        }
        const commonSmell = topItems(tasts.map(t => t.smell));
        const commonTaste = topItems(tasts.map(t => t.taste));
        const commonColour = topItems(tasts.map(t => [t.colour]));
        commonHtml = `
          <div class="section">
            <div class="section-title">Common Notes</div>
            <p><strong>Smell:</strong> ${commonSmell.join(', ') || '—'}</p>
            <p><strong>Taste:</strong> ${commonTaste.join(', ') || '—'}</p>
            <p><strong>Colour:</strong> ${commonColour.join(', ') || '—'}</p>
          </div>`;
      }
      // Helper to format smell/taste descriptors
      function formatDescriptors(list) {
        if (!list || list.length === 0) return '—';
        const groups = {};
        list.forEach(item => {
          let label = '';
          let descriptor = item;
          if (item.includes(':')) {
            const parts = item.split(':');
            label = parts[0].trim();
            descriptor = parts.slice(1).join(':').trim();
          }
          if (!groups[label]) groups[label] = [];
          groups[label].push(descriptor);
        });
        return Object.entries(groups).map(([lbl, descriptors]) => {
          let printLabel = lbl;
          const lower = lbl.toLowerCase();
          // Remove redundant labels if descriptors already include the color word
          if (lower.includes('black') && descriptors.some(d => d.toLowerCase().includes('black'))) {
            printLabel = '';
          }
          if (lower.includes('red') && descriptors.some(d => d.toLowerCase().includes('red'))) {
            printLabel = '';
          }
          const joined = descriptors.join(', ');
          if (printLabel) {
            return `<span class="descriptor-group">${printLabel}: ${joined}</span>`;
          } else {
            return `<span class="descriptor-group">${joined}</span>`;
          }
        }).join(', ');
      }
      // Build tasting entries
      let entriesHtml = '';
      tasts.forEach(t => {
        const index = t.index;
        entriesHtml += `
          <div class="tasting-entry" data-index="${index}">
            <div class="entry-row">
              <div class="entry-label">Winery:</div>
              <div class="entry-value">${t.vineyard || '—'} (x<span class="times" data-index="${index}">${t.timesBought || 1}</span>)</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Wine:</div>
              <div class="entry-value">${t.wineName || '—'}${t.vintage ? ' (' + t.vintage + ')' : ''}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Profile:</div>
              <div class="entry-value">
                ${t.sweetness ? `Sweetness: ${t.sweetness}` : ''}
                ${t.sweetness && t.acidity ? ', ' : ''}
                ${t.acidity ? `Acidity: ${t.acidity}` : ''}
              </div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Smell:</div>
              <div class="entry-value">${formatDescriptors(t.smell)}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Taste:</div>
              <div class="entry-value">${formatDescriptors(t.taste)}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Colour:</div>
              <div class="entry-value">${t.colour || '—'} ${t.intensity || ''}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Ratings:</div>
              <div class="entry-value">
                W: ${t.wineRating || '—'}, V: ${t.wineryRating || '—'}, G: ${t.grapeRating || '—'}
              </div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Purchased:</div>
              <div class="entry-value">
                <button class="small-btn" data-action="dec" data-index="${index}">−</button>
                <span class="times" data-index="${index}">${t.timesBought || 1}</span>
                <button class="small-btn" data-action="inc" data-index="${index}">＋</button>
              </div>
            </div>
            <div class="entry-row entry-actions">
              <button class="small-btn" data-action="edit" data-index="${index}">Edit</button>
              <button class="small-btn" data-action="del" data-index="${index}">Delete</button>
            </div>
          </div>
        `;
      });
      const html = `
        <div class="panel-header">
          <div class="panel-title">${grape} Tastings</div>
          <div class="panel-close" id="grapeBack">← Back</div>
        </div>
        ${commonHtml}
        <div class="panel-list">${entriesHtml || '<p class="empty">No tastings found.</p>'}</div>
      `;
      showOverlay(html);
      // Back button
      document.getElementById('grapeBack').addEventListener('click', showLibrary);
      // Increment/decrement/edit/delete handlers
      overlayContent.querySelectorAll('.small-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.getAttribute('data-action');
          const idx = parseInt(btn.getAttribute('data-index'));
          if (action === 'inc') {
            // Increase purchase count and update UI without re-rendering the whole list
            tastings[idx].timesBought = (tastings[idx].timesBought || 1) + 1;
            saveTastings(tastings);
            updateStats();
            // Update the displayed number
            const timesEl = overlayContent.querySelector(`.times[data-index="${idx}"]`);
            if (timesEl) timesEl.textContent = tastings[idx].timesBought;
          } else if (action === 'dec') {
            tastings[idx].timesBought = Math.max(0, (tastings[idx].timesBought || 1) - 1);
            saveTastings(tastings);
            updateStats();
            const timesEl = overlayContent.querySelector(`.times[data-index="${idx}"]`);
            if (timesEl) timesEl.textContent = tastings[idx].timesBought;
          } else if (action === 'del') {
            tastings.splice(idx, 1);
            saveTastings(tastings);
            updateStats();
            // Refresh library list on delete
            showLibrary();
          } else if (action === 'edit') {
            editTasting(idx);
            // Close overlay so form appears as primary window
            closeOverlay();
          }
        });
      });
    }

    function editTasting(index) {
      // Pre-fill the form with tasting data and set editing mode
      const t = tastings[index];
      document.getElementById('vineyard').value = t.vineyard || '';
      document.getElementById('wineName').value = t.wineName || '';
      document.getElementById('vintage').value = t.vintage || '';
      document.getElementById('grape').value = t.grape || '';
      document.getElementById('wineRating').value = t.wineRating || '';
      document.getElementById('wineryRating').value = t.wineryRating || '';
      document.getElementById('grapeRating').value = t.grapeRating || '';
      document.getElementById('sweetness').value = t.sweetness || '';
      document.getElementById('acidity').value = t.acidity || '';
      // Set colour using custom dropdown helper
      setColourSelection(t.colour || '');
      document.getElementById('colourIntensity').value = t.intensity || '';
      document.getElementById('notes').value = t.notes || '';
      // Set selections for aromas and taste
      selectedAromas = (t.smell || []).slice();
      selectedTastes = (t.taste || []).slice();
      setSelectionsForSection('aromaCategories', selectedAromas);
      setSelectionsForSection('tasteCategories', selectedTastes);
      // Show form
      newTastingSection.style.display = 'block';
      window.scrollTo({ top: newTastingSection.offsetTop - 80, behavior: 'smooth' });
      // Set editIndex so that save handler knows we're updating
      editIndex = index;
      // Change save button text to indicate update
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.textContent = 'Update Tasting';
      // Do not add additional event listener; unified save handler will handle update
    }

    // Show stats page
    function showStats() {
      // Refresh tastings from localStorage
      tastings = getTastings();
      if (tastings.length === 0) {
        showOverlay(`<div class="panel-header"><div class="panel-title">Detailed Stats</div><div class="panel-close" id="statsClose">✕</div></div><p class="empty">No tastings yet.</p>`);
        document.getElementById('statsClose').addEventListener('click', closeOverlay);
        return;
      }
      // Compute counts by grape
      const counts = {};
      tastings.forEach(t => {
        counts[t.grape] = (counts[t.grape] || 0) + 1;
      });
      const countList = Object.entries(counts).sort((a,b) => a[0].localeCompare(b[0]));
      // Compute weighted averages
      function topWeighted(field, ratingField) {
        const agg = {};
        tastings.forEach(t => {
          const key = t[field] || '(Unknown)';
          const weight = t.timesBought || 1;
          const rating = parseFloat(t[ratingField] || 0);
          if (!agg[key]) agg[key] = { sum:0, weight:0 };
          agg[key].sum += rating * weight;
          agg[key].weight += weight;
        });
        const scored = Object.entries(agg).map(([k,v]) => {
          const avg = v.weight ? v.sum / v.weight : 0;
          // frequency weight: tapering weight for counts up to 10
          const freqWeight = 1 + Math.min(v.weight, 10) * 0.05;
          const score = avg * freqWeight;
          return { name: k, avg, weight: v.weight, score };
        });
        scored.sort((a,b) => b.score - a.score);
        return scored.slice(0,5);
      }
      const topWines = topWeighted('wineName', 'wineRating');
      const topWineries = topWeighted('vineyard', 'wineryRating');
      const topGrapes = topWeighted('grape', 'grapeRating');
      // Build HTML for stats with card-based layout
      let html = `<div class="panel-header"><div class="panel-title">Detailed Stats</div><div class="panel-close" id="statsClose">✕</div></div>`;
      // Counts by grape card
      html += `<div class="stats-category-card"><div class="stats-card-title">Counts by Grape</div>${countList.map(([g,c]) => `<div class="stat-row"><span class="stat-name">${g}</span><span class="stat-value">${c}</span></div>`).join('')}</div>`;
      // Top rated wines
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Wines</div>${topWines.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Top rated wineries
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Wineries</div>${topWineries.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Top rated grapes
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Grapes</div>${topGrapes.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Export data button
      html += `<div style="text-align:center;margin-top:1rem;"><button class="btn btn-secondary" id="exportDataBtn">Export Tastings (JSON)</button></div>`;
      showOverlay(html);
      document.getElementById('statsClose').addEventListener('click', closeOverlay);
      // Add export button handler
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        exportTastings();
      });
    }

    // Show personal insights: palate map and blind spots
    function showInsights() {
      // Refresh tastings
      tastings = getTastings();
      if (tastings.length === 0) {
        showOverlay(`<div class="panel-header"><div class="panel-title">Insights</div><div class="panel-close" id="insightsClose">✕</div></div><p class="empty">No tastings yet.</p>`);
        document.getElementById('insightsClose').addEventListener('click', closeOverlay);
        return;
      }
      showInsightsList();
    }

    // Show list of grapes for insights
    function showInsightsList() {
      tastings = getTastings();
      const grapeCounts = {};
      tastings.forEach(t => {
        if (!grapeCounts[t.grape]) grapeCounts[t.grape] = 0;
        grapeCounts[t.grape]++;
      });
      const grapesList = Object.keys(grapeCounts).sort();
      let listHtml = '';
      grapesList.forEach(g => {
        const count = grapeCounts[g];
        listHtml += `<div class="library-item" data-grape="${g}">
          <div class="library-grape">${g}</div>
          <div class="library-count">${count} tasting${count !== 1 ? 's' : ''}</div>
        </div>`;
      });
      const html = `
        <div class="panel-header">
          <div class="panel-title">Insights</div>
          <div class="panel-close" id="insightsClose">✕</div>
        </div>
        <div class="panel-search">
          <input type="text" id="insightsSearch" placeholder="Search grapes..." />
        </div>
        <div id="insightsList" class="panel-list">${listHtml || '<p class="empty">No tastings yet.</p>'}</div>
      `;
      showOverlay(html);
      document.getElementById('insightsClose').addEventListener('click', closeOverlay);
      const searchInput = document.getElementById('insightsSearch');
      const listEl = document.getElementById('insightsList');
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.toLowerCase();
        [...listEl.children].forEach(item => {
          const g = item.getAttribute('data-grape').toLowerCase();
          item.style.display = g.includes(q) ? '' : 'none';
        });
      });
      listEl.addEventListener('click', (e) => {
        const item = e.target.closest('.library-item');
        if (!item) return;
        const grape = item.getAttribute('data-grape');
        showInsightDetail(grape);
      });
    }

    // Show detailed palate map for a specific grape
    function showInsightDetail(grape) {
      // Filter tastings by grape
      const tasts = getTastings().filter(t => t.grape === grape);
      if (tasts.length === 0) {
        showOverlay(`<div class="panel-header"><div class="panel-title">Insights</div><div class="panel-close" id="insightDetailClose">✕</div></div><p class="empty">No data for ${grape}.</p>`);
        document.getElementById('insightDetailClose').addEventListener('click', showInsightsList);
        return;
      }
      // Helper to compute top descriptors for this grape
      function topDescriptorsFor(list, limit=3) {
        const freq = {};
        tasts.forEach(t => {
          (t[list] || []).forEach(item => {
            const key = item.trim().toLowerCase();
            freq[key] = (freq[key] || 0) + 1 * (t.timesBought || 1);
          });
        });
        const sorted = Object.entries(freq).sort((a,b) => b[1] - a[1]);
        return sorted.slice(0, limit).map(([k,v]) => k.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '));
      }
      // Helper to get most common weighted category
      function prefField(field) {
        const counts = {};
        tasts.forEach(t => {
          const val = t[field] || '';
          const weight = t.timesBought || 1;
          if (val) counts[val] = (counts[val] || 0) + weight;
        });
        const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        return entries.length ? entries[0][0] : '—';
      }
      const topSmell = topDescriptorsFor('smell', 3);
      const topTaste = topDescriptorsFor('taste', 3);
      const prefSweetness = prefField('sweetness');
      const prefAcidity = prefField('acidity');
      // Build HTML
      let html = `<div class="panel-header"><div class="panel-title">Insights</div><div class="panel-close" id="insightDetailBack">← Back</div></div>`;
      html += `<div class="stats-category-card"><div class="stats-card-title">Your palate map for ${grape}</div>`;
      html += `<div class="stat-row"><span class="stat-name">Top Aromas</span><span class="stat-value">${topSmell.join(', ') || '—'}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Top Tastes</span><span class="stat-value">${topTaste.join(', ') || '—'}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Preferred Sweetness</span><span class="stat-value">${prefSweetness}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Preferred Acidity</span><span class="stat-value">${prefAcidity}</span></div>`;
      html += `</div>`;
      showOverlay(html);
      document.getElementById('insightDetailBack').addEventListener('click', showInsightsList);
    }
  </script>
  <!-- Service worker registration for PWA and persistent storage request -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // register service worker with scope relative to site root
        navigator.serviceWorker.register('service-worker.js', { scope: './' })
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(err) {
            console.error('Service Worker registration failed:', err);
          });
      });
    }
    // Request persistent storage on supporting browsers to maximise data durability
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist().then(function(granted) {
        console.log('Persistent storage granted:', granted);
      });
    }
  </script>
</body>
</html>

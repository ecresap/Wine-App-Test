<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wine Buddy</title>
  <!-- Google fonts for premium typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Theme color for PWA address bar on mobile -->
  <meta name="theme-color" content="#61101f">
  <style>
    :root {
      /* Rich wine colour palette */
      --wine-900: #2c0510;
      --wine-800: #450a18;
      --wine-700: #61101f;
      --wine-600: #7a1425;
      --wine-500: #8f182b;
      --wine-400: #a9193a;
      --wine-300: #c33d55;
      --wine-200: #da7a8a;
      --wine-100: #f5e6ea;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at 50% 20%, var(--wine-700), var(--wine-900));
      color: var(--wine-100);
      min-height: 100vh;
    }
    /* Global container for consistent horizontal padding */
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
    }
    /* Header / Top bar */
    header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.3);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-left img {
      height: 32px;
      width: 32px;
      object-fit: contain;
    }
    .header-left .app-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }
    /* Hero section */
    .hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 2rem 0 1.5rem;
    }
    .hero-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 0.5rem;
    }
    .hero-headline {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }
    .hero-subheadline {
      font-size: 0.95rem;
      font-weight: 400;
      color: var(--wine-200);
      max-width: 480px;
      line-height: 1.4;
    }
    /* Stats cards */
    .stats-row {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .stat-card {
      flex: 1;
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      position: relative;
      overflow: hidden;
    }
    .stat-icon {
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-icon svg {
      width: 24px;
      height: 24px;
      stroke: #ffffff;
      stroke-width: 1.8;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .stat-number {
      font-size: 2.2rem;
      font-weight: 700;
    }
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--wine-200);
      letter-spacing: 0.05em;
    }
    /* Action cards */
    .action-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 2rem;
    }
    .action-card {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .action-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-icon svg {
      width: 28px;
      height: 28px;
      stroke: #ffffff;
      stroke-width: 1.8;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .action-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .action-desc {
      font-size: 0.8rem;
      color: var(--wine-200);
    }
    /* Form panel styling */
    .form-panel {
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      margin-top: 1rem;
    }
    .form-panel .section {
      margin-bottom: 1.5rem;
    }
    .form-panel .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      padding-bottom: 0.3rem;
    }
    .form-panel .field {
      margin-bottom: 1rem;
      text-align: left;
    }
    .form-panel label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
      color: var(--wine-200);
    }
    .form-panel input,
    .form-panel select,
    .form-panel textarea {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: none;
      background: #150910;
      color: var(--wine-100);
      box-shadow: inset 0 0 0 1px #4a0915;
      font-size: 0.95rem;
    }
    .form-panel input::placeholder,
    .form-panel textarea::placeholder {
      color: #987;
    }
    /* Chips for smell/taste */
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .chip {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.1);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .chip.selected {
      background: var(--wine-500);
    }
    /* Form buttons */
    .form-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    .btn {
      width: 100%;
      padding: 0.9rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary {
      background: var(--wine-500);
      color: white;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--wine-200);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    /* Toast message */
    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--wine-500);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 100;
    }

    /* Overlay for library and stats */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      overflow-y: auto;
      display: none;
    }
    .panel {
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      margin: 4rem auto 2rem;
      max-width: 600px;
      color: var(--wine-100);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .panel-title {
      font-size: 1.3rem;
      font-weight: 600;
    }
    .panel-close {
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 0.4rem;
      transition: background 0.2s ease;
    }
    .panel-close:hover {
      background: rgba(255,255,255,0.1);
    }
    .panel-search {
      margin-bottom: 1rem;
    }
    .panel-search input {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: none;
      background: #150910;
      color: var(--wine-100);
      box-shadow: inset 0 0 0 1px #4a0915;
      font-size: 0.9rem;
    }
    .panel-list {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    .library-item {
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 0.8rem;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .library-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.5);
    }
    .library-grape {
      font-size: 1rem;
      font-weight: 600;
    }
    .library-count {
      font-size: 0.8rem;
      color: var(--wine-200);
    }
    .empty {
      color: var(--wine-200);
      text-align: center;
      margin-top: 1rem;
    }
    .tasting-entry {
      background: linear-gradient(160deg, var(--wine-700), var(--wine-500));
      border-radius: 0.8rem;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    .entry-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .entry-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--wine-200);
      min-width: 80px;
    }
    .entry-value {
      font-size: 0.9rem;
      flex: 1;
      text-align: left;
    }
    .entry-actions {
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Small buttons for increment/decrement/edit/delete */
    .small-btn {
      background: var(--wine-400);
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.4rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .small-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .small-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    /* Stats cards for detailed stats page */
    .stats-category-card {
      width: 100%;
      background: linear-gradient(160deg, var(--wine-800), var(--wine-600));
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    .stats-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .stats-category-card .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 0.9rem;
    }
    .stats-category-card .stat-row:not(:last-child) {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .stats-category-card .stat-row:nth-child(odd) {
      background: rgba(255,255,255,0.04);
    }
    .stats-category-card .stat-name {
      flex: 1;
      text-align: left;
    }
    .stats-category-card .stat-value {
      flex-shrink: 0;
      text-align: right;
      margin-left: 1rem;
    }

    /* Descriptor groups for smell/taste */
    .descriptor-group {
      display: inline-block;
      margin-right: 0.4rem;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- Top bar / Header -->
  <header>
    <div class="header-left">
      <img src="logo.png" alt="Wine Buddy logo">
      <span class="app-name">Wine Buddy</span>
    </div>
    <div class="header-right">
      <!-- Placeholder for future profile/settings -->
      <span class="header-icon">☰</span>
    </div>
  </header>

  <main class="container" id="main">
    <!-- Hero Section -->
    <section class="hero">
      <img src="logo.png" alt="Wine Buddy logo" class="hero-logo">
      <h2 class="hero-headline">Discover your wine palate.</h2>
      <p class="hero-subheadline">Record tastings, track your favorite grapes, and explore your unique flavor patterns.</p>
    </section>

    <!-- Stats Cards -->
    <section class="stats-row">
      <div class="stat-card" id="stat-tastings">
        <div class="stat-icon">
          <!-- Wine glass outline icon -->
          <svg viewBox="0 0 24 24">
            <path d="M8 2h8l-1 6c0 2.5-2 4.5-4 4.5s-4-2-4-4.5l-1-6z" />
            <line x1="12" y1="12.5" x2="12" y2="20" />
            <line x1="9" y1="20" x2="15" y2="20" />
          </svg>
        </div>
        <div class="stat-number" id="tastingCount">0</div>
        <div class="stat-label">Tastings</div>
      </div>
      <div class="stat-card" id="stat-grapes">
        <div class="stat-icon">
          <!-- Grape cluster icon -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="7" r="3" />
            <circle cx="9" cy="12" r="3" />
            <circle cx="15" cy="12" r="3" />
            <circle cx="12" cy="17" r="3" />
          </svg>
        </div>
        <div class="stat-number" id="grapeCount">0</div>
        <div class="stat-label">Grapes</div>
      </div>
    </section>

    <!-- Action Cards -->
    <section class="action-list">
      <div class="action-card" id="newTastingBtn">
        <div class="action-icon">
          <!-- Plus in circle icon -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9" />
            <line x1="12" y1="8" x2="12" y2="16" />
            <line x1="8" y1="12" x2="16" y2="12" />
          </svg>
        </div>
        <div>
          <div class="action-title">New Tasting</div>
          <div class="action-desc">Start a new wine entry</div>
        </div>
      </div>
      <div class="action-card" id="libraryBtn">
        <div class="action-icon">
          <!-- List icon -->
          <svg viewBox="0 0 24 24">
            <line x1="9" y1="6" x2="20" y2="6" />
            <line x1="9" y1="12" x2="20" y2="12" />
            <line x1="9" y1="18" x2="20" y2="18" />
            <circle cx="5" cy="6" r="1.2" />
            <circle cx="5" cy="12" r="1.2" />
            <circle cx="5" cy="18" r="1.2" />
          </svg>
        </div>
        <div>
          <div class="action-title">Tasting Library</div>
          <div class="action-desc">Browse all your tastings</div>
        </div>
      </div>
      <div class="action-card" id="statsBtn">
        <div class="action-icon">
          <!-- Trend line icon -->
          <svg viewBox="0 0 24 24">
            <polyline points="4 16 9 11 14 14 20 6" />
            <circle cx="4" cy="16" r="1.2" />
            <circle cx="9" cy="11" r="1.2" />
            <circle cx="14" cy="14" r="1.2" />
            <circle cx="20" cy="6" r="1.2" />
          </svg>
        </div>
        <div>
          <div class="action-title">Detailed Stats</div>
          <div class="action-desc">See your palate stats</div>
        </div>
      </div>
      <!-- Insights card for palate map and blind spots -->
      <div class="action-card" id="insightsBtn">
        <div class="action-icon">
          <!-- Star icon representing insights -->
          <svg viewBox="0 0 24 24">
            <polygon points="12 2 14.5 8.5 21 9 16 13 17.5 19.5 12 16 6.5 19.5 8 13 3 9 9.5 8.5 12 2"/>
          </svg>
        </div>
        <div>
          <div class="action-title">Insights</div>
          <div class="action-desc">Palate map & blind spots</div>
        </div>
      </div>
    </section>

    <!-- New Tasting Form (hidden by default) -->
    <section id="newTastingSection" style="display:none;">
      <div class="form-panel">
        <h3 style="margin-top:0; margin-bottom:1rem; font-size:1.2rem; font-weight:600;">New Tasting</h3>
        <!-- Basic Info -->
        <div class="section">
          <div class="section-title">Basic Info</div>
          <div class="field">
            <label for="vineyard">Vineyard / Winery</label>
            <input type="text" id="vineyard" placeholder="Enter winery name" />
          </div>
          <div class="field">
            <label for="wineName">Wine Name</label>
            <input type="text" id="wineName" placeholder="Enter wine name" />
          </div>
          <div class="field">
            <label for="vintage">Vintage Year</label>
            <input type="number" id="vintage" placeholder="e.g., 2021" />
          </div>
          <div class="field">
            <label for="grape">Grape Variety</label>
            <select id="grape">
              <!-- Grape options will be populated by script -->
            </select>
          </div>
        </div>
        <!-- Ratings -->
        <div class="section">
          <div class="section-title">Ratings</div>
          <div class="field">
            <label for="wineRating">Wine Rating (1–10)</label>
            <select id="wineRating">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="field">
            <label for="wineryRating">Winery Rating (1–10)</label>
            <select id="wineryRating">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="field">
            <label for="grapeRating">Grape Rating (1–10)</label>
            <select id="grapeRating">
              <option value="">-- Select --</option>
            </select>
          </div>
        </div>
        <!-- Profile -->
        <div class="section">
          <div class="section-title">Profile</div>
          <div class="field">
            <label for="sweetness">Sweetness</label>
            <select id="sweetness">
              <option value="">-- Select --</option>
              <option value="Dry">Dry</option>
              <option value="Off-Dry">Off-Dry</option>
              <option value="Medium-Dry">Medium-Dry</option>
              <option value="Medium-Sweet">Medium-Sweet</option>
              <option value="Sweet">Sweet</option>
              <option value="Luscious">Luscious</option>
            </select>
          </div>
          <div class="field">
            <label for="acidity">Acidity</label>
            <select id="acidity">
              <option value="">-- Select --</option>
              <option value="Low">Low</option>
              <option value="Medium(-)">Medium(-)</option>
              <option value="Medium">Medium</option>
              <option value="Medium(+)">Medium(+)</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <!-- Aromas & Flavors -->
        <div class="section">
          <div class="section-title">Smell (select up to 4)</div>
          <div class="chip-container" id="smellChips"></div>
        </div>
        <div class="section">
          <div class="section-title">Taste (select up to 4)</div>
          <div class="chip-container" id="tasteChips"></div>
        </div>
        <div class="section">
          <div class="section-title">Colour</div>
          <div class="field">
            <label for="colourType">Colour Type</label>
            <select id="colourType">
              <option value="">-- Select --</option>
              <option value="Ruby">Ruby</option>
              <option value="Garnet">Garnet</option>
              <option value="Purple">Purple</option>
              <option value="Tawny">Tawny</option>
              <option value="Lemon-Green">Lemon-Green</option>
              <option value="Lemon">Lemon</option>
              <option value="Gold">Gold</option>
              <option value="Amber">Amber</option>
              <option value="Pink">Pink</option>
              <option value="Salmon">Salmon</option>
              <option value="Copper">Copper</option>
              <option value="Mahogany">Mahogany</option>
            </select>
          </div>
          <div class="field">
            <label for="colourIntensity">Colour Intensity</label>
            <select id="colourIntensity">
              <option value="">-- Select --</option>
              <option value="Light">Light</option>
              <option value="Medium">Medium</option>
              <option value="Deep">Deep</option>
            </select>
          </div>
        </div>
        <!-- Additional notes -->
        <div class="section">
          <div class="section-title">Additional Notes</div>
          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" rows="3" placeholder="Write any tasting notes..."></textarea>
          </div>
        </div>
        <!-- Form Buttons -->
        <div class="form-buttons">
          <button class="btn btn-primary" id="saveBtn">Save Tasting</button>
          <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Tasting saved!</div>

  <!-- Overlay for Library and Stats -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="overlayContent" class="panel"></div>
  </div>

  <script src="localStorage.js"></script>
  <script>
    // Data arrays for grapes, smell, and taste notes (alphabetical)
    const grapes = [
      'Cabernet Sauvignon',
      'Merlot',
      'Pinot Noir / Pinot Nero / Spätburgunder',
      'Syrah / Shiraz',
      'Grenache / Garnacha / Cannonau',
      'Tempranillo / Tinta Roriz / Aragonez',
      'Sangiovese',
      'Malbec / Côt',
      'Cabernet Franc',
      'Zinfandel / Primitivo',
      'Nebbiolo',
      'Barbera',
      'Gamay',
      'Mourvèdre / Monastrell / Mataro',
      'Carignan / Mazuelo / Cariñena',
      'Petit Verdot',
      'Pinotage',
      'Touriga Nacional',
      'Aglianico',
      'Corvina',
      'Dolcetto',
      'Nero d\'Avola',
      'Tannat',
      'Blaufränkisch / Lemberger / Kékfrankos',
      'Carmenère',
      'Mencía',
      'Montepulciano',
      'Sagrantino',
      'Lagrein',
      'Frappato',
      'Bonarda (Argentinian / Douce Noir)',
      'Refosco',
      'Graciano',
      'Xinomavro',
      'Schiava / Trollinger / Vernatsch',
      'Pinot Meunier',
      'Negroamaro',
      'Saperavi',
      'Petite Sirah / Durif',
      'Counoise',
      'Cinsault / Cinsaut',
      'Teroldego',
      'Lambrusco (Grasparossa / Sorbara / Salamino)',
      'Zweigelt',
      'Saint Laurent',
      'Kadarka',
      'Colorino',
      'Pelaverga',
      'País / Mission / Criolla',
      'Touriga Franca',
      'Castelão / Periquita',
      'Bobal',
      'Nielluccio (Corsican Sangiovese)',
      'Alicante Bouschet',
      'Braucol / Fer Servadou',
      'Mondeuse Noire',
      'Marzemino',
      'Cesanese',
      'Grolleau Noir',
      'Mourisco Tinto',
      'Nero di Troia / Uva di Troia',
      'Primitivo di Manduria (style)',
      'Cabernet Dorsa',
      'Corvinone',
      'Negrette / Négrette',
      'Pinot Noir Précoce / Frühburgunder',
      'Nerello Mascalese',
      'Nerello Cappuccio',
      'Plavac Mali',
      'Mavrud',
      'Chardonnay',
      'Sauvignon Blanc',
      'Pinot Gris / Pinot Grigio / Grauburgunder',
      'Riesling',
      'Gewürztraminer / Traminer Aromatico',
      'Viognier',
      'Sémillon',
      'Chenin Blanc',
      'Albariño / Alvarinho',
      'Verdejo',
      'Trebbiano / Ugni Blanc',
      'Garganega',
      'Fiano',
      'Greco',
      'Verdicchio',
      'Cortese',
      'Pecorino',
      'Moscato Bianco / Muscat Blanc à Petits Grains',
      'Torrontés',
      'Palomino Fino',
      'Pedro Ximénez',
      'Airén',
      'Macabeo / Viura',
      'Parellada',
      'Xarel-lo',
      'Grüner Veltliner',
      'Müller-Thurgau',
      'Silvaner',
      'Rkatsiteli',
      'Assyrtiko',
      'Bordeaux Red Blend',
      'Bordeaux White Blend',
      'GSM / Southern Rhône Red Blend',
      'Champagne / Traditional Method Sparkling Blend',
      'Super Tuscan Red Blend'
    ];
    const smellOptions = [
      // Updated smell list (will also be used for taste)
      'Acacia',
      'Almond',
      'Apple',
      'Apricot',
      'Banana',
      'Bark',
      'Black Cherry',
      'Black Pepper',
      'Black Plum',
      'Blackberry',
      'Blackcurrant',
      'Butter',
      'Caramel',
      'Cedar',
      'Cinnamon',
      'Citrus: Lemon',
      'Citrus: Lime',
      'Clove',
      'Cranberry',
      'Dried Fruit',
      'Earthy',
      'Elderflower',
      'Forest Floor',
      'Grapefruit',
      'Grass',
      'Hazelnut',
      'Honey',
      'Honeysuckle',
      'Jasmine',
      'Lavender',
      'Leather',
      'Lemon Zest',
      'Mango',
      'Mint',
      'Mushroom',
      'Nutmeg',
      'Nutty',
      'Orange',
      'Orange Peel',
      'Passion Fruit',
      'Peach',
      'Nectarine',
      'Pear',
      'Pineapple',
      'Raspberry',
      'Red Cherry',
      'Red Plum',
      'Rose',
      'Stone',
      'Strawberry',
      'Tobacco',
      'Vanilla',
      'Violet',
      'Wet Leaves'
    ];
    const tasteOptions = [...smellOptions];
    // Populate grape and rating selects
    const grapeSelect = document.getElementById('grape');
    grapes.sort().forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      grapeSelect.appendChild(opt);
    });
    function populateRatingSelect(id) {
      const sel = document.getElementById(id);
      for (let i=1; i<=10; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        sel.appendChild(opt);
      }
    }
    populateRatingSelect('wineRating');
    populateRatingSelect('wineryRating');
    populateRatingSelect('grapeRating');
    // Populate smell and taste chips
    function createChips(containerId, options) {
      const container = document.getElementById(containerId);
      options.sort().forEach(item => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = item;
        chip.addEventListener('click', () => {
          // Toggle selection; limit to 4 chips
          const selected = [...container.querySelectorAll('.chip.selected')];
          if (chip.classList.contains('selected')) {
            chip.classList.remove('selected');
          } else if (selected.length < 4) {
            chip.classList.add('selected');
          }
        });
        container.appendChild(chip);
      });
    }
    createChips('smellChips', smellOptions);
    createChips('tasteChips', tasteOptions);

    // Example counters; replace these with actual data if storing tastings
    let tastings = getTastings();
    function updateStats() {
      // Refresh tastings from localStorage each time stats are updated
      tastings = getTastings();
      const tastingCount = tastings.length;
      const grapeCount = new Set(tastings.map(t => t.grape)).size;
      animateNumber('tastingCount', tastingCount);
      animateNumber('grapeCount', grapeCount);
    }
    function animateNumber(id, target) {
      const el = document.getElementById(id);
      const duration = 800;
      const startTime = performance.now();
      function step(currentTime) {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = Math.floor(progress * target);
        el.textContent = value;
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    // Show/hide New Tasting section
    const newTastingBtn = document.getElementById('newTastingBtn');
    const newTastingSection = document.getElementById('newTastingSection');
    const cancelBtn = document.getElementById('cancelBtn');
    newTastingBtn.addEventListener('click', () => {
      newTastingSection.style.display = 'block';
      window.scrollTo({ top: newTastingSection.offsetTop - 80, behavior: 'smooth' });
    });
    cancelBtn.addEventListener('click', () => {
      newTastingSection.style.display = 'none';
      document.getElementById('vineyard').value = '';
      document.getElementById('wineName').value = '';
      document.getElementById('vintage').value = '';
      document.getElementById('grape').selectedIndex = 0;
      document.getElementById('wineRating').selectedIndex = 0;
      document.getElementById('wineryRating').selectedIndex = 0;
      document.getElementById('grapeRating').selectedIndex = 0;
      document.getElementById('sweetness').selectedIndex = 0;
      document.getElementById('acidity').selectedIndex = 0;
      document.getElementById('colourType').selectedIndex = 0;
      document.getElementById('colourIntensity').selectedIndex = 0;
      document.getElementById('notes').value = '';
      // Reset chips
      document.querySelectorAll('.chip.selected').forEach(chip => chip.classList.remove('selected'));
    });
    // Save tasting
    document.getElementById('saveBtn').addEventListener('click', () => {
      const t = {
        vineyard: document.getElementById('vineyard').value.trim(),
        wineName: document.getElementById('wineName').value.trim(),
        vintage: document.getElementById('vintage').value.trim(),
        grape: document.getElementById('grape').value,
        wineRating: document.getElementById('wineRating').value,
        wineryRating: document.getElementById('wineryRating').value,
        grapeRating: document.getElementById('grapeRating').value,
        sweetness: document.getElementById('sweetness').value,
        acidity: document.getElementById('acidity').value,
        smell: [...document.querySelectorAll('#smellChips .chip.selected')].map(ch => ch.textContent),
        taste: [...document.querySelectorAll('#tasteChips .chip.selected')].map(ch => ch.textContent),
        colour: document.getElementById('colourType').value,
        intensity: document.getElementById('colourIntensity').value,
        notes: document.getElementById('notes').value.trim(),
        createdAt: new Date().toISOString(),
        timesBought: 1
      };
      // Persist the new tasting to localStorage and refresh tastings
      addTasting(t);
      tastings = getTastings();
      // Reset form and hide
      cancelBtn.click();
      // Update stats
      updateStats();
      // Show toast
      const toast = document.getElementById('toast');
      toast.textContent = 'Tasting saved!';
      toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, 2000);
    });
    // Initialize counters
    updateStats();

    /* ------------------------------ Library & Stats Overlay ------------------------------ */
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlayContent');
    // Show overlay with provided HTML content
    function showOverlay(html) {
      overlayContent.innerHTML = html;
      overlay.style.display = 'block';
    }
    // Close overlay
    function closeOverlay() {
      overlay.style.display = 'none';
      overlayContent.innerHTML = '';
    }
    // Close overlay when clicking on backdrop
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        closeOverlay();
      }
    });
    // Library button
    document.getElementById('libraryBtn').addEventListener('click', () => {
      showLibrary();
    });
    // Stats button
    document.getElementById('statsBtn').addEventListener('click', () => {
      showStats();
    });

    // Insights button
    document.getElementById('insightsBtn').addEventListener('click', () => {
      showInsights();
    });

    // Show the Tasting Library
    function showLibrary() {
      // Refresh tastings from localStorage
      tastings = getTastings();
      // Create search and list of grapes
      const grapeCounts = {};
      tastings.forEach((t, idx) => {
        if (!grapeCounts[t.grape]) grapeCounts[t.grape] = 0;
        grapeCounts[t.grape]++;
      });
      const grapesList = Object.keys(grapeCounts).sort();
      let listHtml = '';
      grapesList.forEach(g => {
        const count = grapeCounts[g];
        listHtml += `<div class="library-item" data-grape="${g}">\n`
          + `<div class="library-grape">${g}</div>`
          + `<div class="library-count">${count} tasting${count !== 1 ? 's' : ''}</div>`
          + `</div>`;
      });
      const html = `
        <div class="panel-header">
          <div class="panel-title">Tasting Library</div>
          <div class="panel-close" id="libraryClose">✕</div>
        </div>
        <div class="panel-search">
          <input type="text" id="librarySearch" placeholder="Search grapes..." />
        </div>
        <div id="libraryList" class="panel-list">${listHtml || '<p class="empty">No tastings yet.</p>'}</div>
      `;
      showOverlay(html);
      // Close
      document.getElementById('libraryClose').addEventListener('click', closeOverlay);
      const searchInput = document.getElementById('librarySearch');
      const listEl = document.getElementById('libraryList');
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.toLowerCase();
        [...listEl.children].forEach(item => {
          const g = item.getAttribute('data-grape').toLowerCase();
          item.style.display = g.includes(q) ? '' : 'none';
        });
      });
      // Click on grape item
      listEl.addEventListener('click', (e) => {
        const item = e.target.closest('.library-item');
        if (!item) return;
        const grape = item.getAttribute('data-grape');
        showGrapeDetail(grape);
      });
    }

    function showGrapeDetail(grape) {
      // Refresh tastings from localStorage
      tastings = getTastings();
      // Filter tastings by grape
      const tasts = tastings.map((t, idx) => ({ ...t, index: idx }))
        .filter(t => t.grape === grape);
      // Compute common notes if count >= 3
      let commonHtml = '';
      if (tasts.length >= 3) {
        function topItems(arrays) {
          const freq = {};
          arrays.forEach(list => list.forEach(item => {
            const key = item.toLowerCase();
            freq[key] = (freq[key] || 0) + 1;
          }));
          const sorted = Object.entries(freq).sort((a,b) => b[1]-a[1]);
          return sorted.filter(([k,v]) => v > 1).slice(0,5).map(([k,v]) => k.charAt(0).toUpperCase() + k.slice(1));
        }
        const commonSmell = topItems(tasts.map(t => t.smell));
        const commonTaste = topItems(tasts.map(t => t.taste));
        const commonColour = topItems(tasts.map(t => [t.colour]));
        commonHtml = `
          <div class="section">
            <div class="section-title">Common Notes</div>
            <p><strong>Smell:</strong> ${commonSmell.join(', ') || '—'}</p>
            <p><strong>Taste:</strong> ${commonTaste.join(', ') || '—'}</p>
            <p><strong>Colour:</strong> ${commonColour.join(', ') || '—'}</p>
          </div>`;
      }
      // Helper to format smell/taste descriptors
      function formatDescriptors(list) {
        if (!list || list.length === 0) return '—';
        const groups = {};
        list.forEach(item => {
          let label = '';
          let descriptor = item;
          if (item.includes(':')) {
            const parts = item.split(':');
            label = parts[0].trim();
            descriptor = parts.slice(1).join(':').trim();
          }
          if (!groups[label]) groups[label] = [];
          groups[label].push(descriptor);
        });
        return Object.entries(groups).map(([lbl, descriptors]) => {
          let printLabel = lbl;
          const lower = lbl.toLowerCase();
          // Remove redundant labels if descriptors already include the color word
          if (lower.includes('black') && descriptors.some(d => d.toLowerCase().includes('black'))) {
            printLabel = '';
          }
          if (lower.includes('red') && descriptors.some(d => d.toLowerCase().includes('red'))) {
            printLabel = '';
          }
          const joined = descriptors.join(', ');
          if (printLabel) {
            return `<span class="descriptor-group">${printLabel}: ${joined}</span>`;
          } else {
            return `<span class="descriptor-group">${joined}</span>`;
          }
        }).join(', ');
      }
      // Build tasting entries
      let entriesHtml = '';
      tasts.forEach(t => {
        const index = t.index;
        entriesHtml += `
          <div class="tasting-entry" data-index="${index}">
            <div class="entry-row">
              <div class="entry-label">Winery:</div>
              <div class="entry-value">${t.vineyard || '—'} (x<span class="times" data-index="${index}">${t.timesBought || 1}</span>)</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Wine:</div>
              <div class="entry-value">${t.wineName || '—'}${t.vintage ? ' (' + t.vintage + ')' : ''}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Profile:</div>
              <div class="entry-value">${(t.sweetness || '') + (t.sweetness && t.acidity ? ', ' : '') + (t.acidity || '')}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Smell:</div>
              <div class="entry-value">${formatDescriptors(t.smell)}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Taste:</div>
              <div class="entry-value">${formatDescriptors(t.taste)}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Colour:</div>
              <div class="entry-value">${t.colour || '—'} ${t.intensity || ''}</div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Ratings:</div>
              <div class="entry-value">
                W: ${t.wineRating || '—'}, V: ${t.wineryRating || '—'}, G: ${t.grapeRating || '—'}
              </div>
            </div>
            <div class="entry-row">
              <div class="entry-label">Purchased:</div>
              <div class="entry-value">
                <button class="small-btn" data-action="dec" data-index="${index}">−</button>
                <span class="times" data-index="${index}">${t.timesBought || 1}</span>
                <button class="small-btn" data-action="inc" data-index="${index}">＋</button>
              </div>
            </div>
            <div class="entry-row entry-actions">
              <button class="small-btn" data-action="edit" data-index="${index}">Edit</button>
              <button class="small-btn" data-action="del" data-index="${index}">Delete</button>
            </div>
          </div>
        `;
      });
      const html = `
        <div class="panel-header">
          <div class="panel-title">${grape} Tastings</div>
          <div class="panel-close" id="grapeBack">← Back</div>
        </div>
        ${commonHtml}
        <div class="panel-list">${entriesHtml || '<p class="empty">No tastings found.</p>'}</div>
      `;
      showOverlay(html);
      // Back button
      document.getElementById('grapeBack').addEventListener('click', showLibrary);
      // Increment/decrement/edit/delete handlers
      overlayContent.querySelectorAll('.small-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.getAttribute('data-action');
          const idx = parseInt(btn.getAttribute('data-index'));
          if (action === 'inc') {
            tastings[idx].timesBought = (tastings[idx].timesBought || 1) + 1;
            // Persist change
            saveTastings(tastings);
            updateStats();
            showGrapeDetail(grape);
          } else if (action === 'dec') {
            tastings[idx].timesBought = Math.max(0, (tastings[idx].timesBought || 1) - 1);
            // Persist change
            saveTastings(tastings);
            updateStats();
            showGrapeDetail(grape);
          } else if (action === 'del') {
            tastings.splice(idx, 1);
            // Persist change
            saveTastings(tastings);
            updateStats();
            showLibrary();
          } else if (action === 'edit') {
            // Launch edit form
            editTasting(idx);
          }
        });
      });
    }

    function editTasting(index) {
      // Pre-fill the form with tasting data and set editing mode
      const t = tastings[index];
      document.getElementById('vineyard').value = t.vineyard || '';
      document.getElementById('wineName').value = t.wineName || '';
      document.getElementById('vintage').value = t.vintage || '';
      document.getElementById('grape').value = t.grape || '';
      document.getElementById('wineRating').value = t.wineRating || '';
      document.getElementById('wineryRating').value = t.wineryRating || '';
      document.getElementById('grapeRating').value = t.grapeRating || '';
      document.getElementById('sweetness').value = t.sweetness || '';
      document.getElementById('acidity').value = t.acidity || '';
      document.getElementById('colourType').value = t.colour || '';
      document.getElementById('colourIntensity').value = t.intensity || '';
      document.getElementById('notes').value = t.notes || '';
      // Reset chips
      document.querySelectorAll('#smellChips .chip').forEach(chip => {
        chip.classList[t.smell.includes(chip.textContent) ? 'add' : 'remove']('selected');
      });
      document.querySelectorAll('#tasteChips .chip').forEach(chip => {
        chip.classList[t.taste.includes(chip.textContent) ? 'add' : 'remove']('selected');
      });
      // Show form
      newTastingSection.style.display = 'block';
      window.scrollTo({ top: newTastingSection.offsetTop - 80, behavior: 'smooth' });
      // Change save button to update
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Update Tasting';
      // Temporarily change handler
      const handler = function() {
        // Update tasting
        t.vineyard = document.getElementById('vineyard').value.trim();
        t.wineName = document.getElementById('wineName').value.trim();
        t.vintage = document.getElementById('vintage').value.trim();
        t.grape = document.getElementById('grape').value;
        t.wineRating = document.getElementById('wineRating').value;
        t.wineryRating = document.getElementById('wineryRating').value;
        t.grapeRating = document.getElementById('grapeRating').value;
        t.sweetness = document.getElementById('sweetness').value;
        t.acidity = document.getElementById('acidity').value;
        t.smell = [...document.querySelectorAll('#smellChips .chip.selected')].map(ch => ch.textContent);
        t.taste = [...document.querySelectorAll('#tasteChips .chip.selected')].map(ch => ch.textContent);
        t.colour = document.getElementById('colourType').value;
        t.intensity = document.getElementById('colourIntensity').value;
        t.notes = document.getElementById('notes').value.trim();
        t.updatedAt = new Date().toISOString();
        // Save updated tastings list to localStorage
        saveTastings(tastings);
        // Reset form and restore button
        cancelBtn.click();
        saveBtn.textContent = originalText;
        saveBtn.removeEventListener('click', handler);
        // Update stats and refresh library or detail view
        updateStats();
        closeOverlay();
      };
      // Remove existing click handlers to avoid duplicates (not necessary if not editing multiple times quickly)
      saveBtn.addEventListener('click', handler);
    }

    // Show stats page
    function showStats() {
      // Refresh tastings from localStorage
      tastings = getTastings();
      if (tastings.length === 0) {
        showOverlay(`<div class="panel-header"><div class="panel-title">Detailed Stats</div><div class="panel-close" id="statsClose">✕</div></div><p class="empty">No tastings yet.</p>`);
        document.getElementById('statsClose').addEventListener('click', closeOverlay);
        return;
      }
      // Compute counts by grape
      const counts = {};
      tastings.forEach(t => {
        counts[t.grape] = (counts[t.grape] || 0) + 1;
      });
      const countList = Object.entries(counts).sort((a,b) => a[0].localeCompare(b[0]));
      // Compute weighted averages
      function topWeighted(field, ratingField) {
        const agg = {};
        tastings.forEach(t => {
          const key = t[field] || '(Unknown)';
          const weight = t.timesBought || 1;
          const rating = parseFloat(t[ratingField] || 0);
          if (!agg[key]) agg[key] = { sum:0, weight:0 };
          agg[key].sum += rating * weight;
          agg[key].weight += weight;
        });
        const scored = Object.entries(agg).map(([k,v]) => {
          const avg = v.weight ? v.sum / v.weight : 0;
          // frequency weight: tapering weight for counts up to 10
          const freqWeight = 1 + Math.min(v.weight, 10) * 0.05;
          const score = avg * freqWeight;
          return { name: k, avg, weight: v.weight, score };
        });
        scored.sort((a,b) => b.score - a.score);
        return scored.slice(0,5);
      }
      const topWines = topWeighted('wineName', 'wineRating');
      const topWineries = topWeighted('vineyard', 'wineryRating');
      const topGrapes = topWeighted('grape', 'grapeRating');
      // Build HTML for stats with card-based layout
      let html = `<div class="panel-header"><div class="panel-title">Detailed Stats</div><div class="panel-close" id="statsClose">✕</div></div>`;
      // Counts by grape card
      html += `<div class="stats-category-card"><div class="stats-card-title">Counts by Grape</div>${countList.map(([g,c]) => `<div class="stat-row"><span class="stat-name">${g}</span><span class="stat-value">${c}</span></div>`).join('')}</div>`;
      // Top rated wines
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Wines</div>${topWines.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Top rated wineries
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Wineries</div>${topWineries.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Top rated grapes
      html += `<div class="stats-category-card"><div class="stats-card-title">Top Rated Grapes</div>${topGrapes.map(item => `<div class="stat-row"><span class="stat-name">${item.name}</span><span class="stat-value">${item.avg.toFixed(1)} (${item.weight})</span></div>`).join('')}</div>`;
      // Export data button
      html += `<div style="text-align:center;margin-top:1rem;"><button class="btn btn-secondary" id="exportDataBtn">Export Tastings (JSON)</button></div>`;
      showOverlay(html);
      document.getElementById('statsClose').addEventListener('click', closeOverlay);
      // Add export button handler
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        exportTastings();
      });
    }

    // Show personal insights: palate map and blind spots
    function showInsights() {
      // Refresh tastings from localStorage
      tastings = getTastings();
      const count = tastings.length;
      if (count === 0) {
        showOverlay(`<div class="panel-header"><div class="panel-title">Insights</div><div class="panel-close" id="insightsClose">✕</div></div><p class="empty">No tastings yet.</p>`);
        document.getElementById('insightsClose').addEventListener('click', closeOverlay);
        return;
      }
      // Helper: compute top descriptors from list of arrays
      function topDescriptors(property, limit = 5) {
        const freq = {};
        tastings.forEach(t => {
          (t[property] || []).forEach(item => {
            const key = item.trim().toLowerCase();
            freq[key] = (freq[key] || 0) + 1 * (t.timesBought || 1);
          });
        });
        const sorted = Object.entries(freq).sort((a,b) => b[1] - a[1]);
        return sorted.slice(0, limit).map(([k, v]) => {
          // Capitalize each word
          return k.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        });
      }
      // Helper: most common categorical value, weighted by timesBought
      function mostCommon(values) {
        const counts = {};
        tastings.forEach(t => {
          const val = t[values] || '';
          const weight = t.timesBought || 1;
          if (val) counts[val] = (counts[val] || 0) + weight;
        });
        const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        return entries.length > 0 ? entries[0][0] : '—';
      }
      // Compute palate map
      const topSmell = topDescriptors('smell', 5);
      const topTaste = topDescriptors('taste', 5);
      // Structural preferences: sweetness and acidity
      const prefSweetness = mostCommon('sweetness');
      const prefAcidity = mostCommon('acidity');
      // Favourite grapes: use existing topWeighted function logic but limit to 5
      function topFavouriteGrapes() {
        const agg = {};
        tastings.forEach(t => {
          const key = t.grape || '(Unknown)';
          const weight = t.timesBought || 1;
          const rating = parseFloat(t.grapeRating || 0);
          if (!agg[key]) agg[key] = { sum: 0, weight: 0 };
          agg[key].sum += rating * weight;
          agg[key].weight += weight;
        });
        const scored = Object.entries(agg).map(([k,v]) => {
          const avg = v.weight ? v.sum / v.weight : 0;
          const freqWeight = 1 + Math.min(v.weight, 10) * 0.05;
          const score = avg * freqWeight;
          return { name: k, avg: avg, weight: v.weight, score };
        });
        scored.sort((a,b) => b.score - a.score);
        return scored.slice(0,5).map(item => `${item.name} (${item.avg.toFixed(1)})`);
      }
      const favouriteGrapes = topFavouriteGrapes();
      // Compute blind spots
      // Descriptors never chosen (smell + taste options combined)
      const allDescriptors = new Set(smellOptions.map(s => s.toLowerCase()));
      tastings.forEach(t => {
        (t.smell || []).forEach(item => allDescriptors.delete(item.toLowerCase()));
        (t.taste || []).forEach(item => allDescriptors.delete(item.toLowerCase()));
      });
      const neverSelected = Array.from(allDescriptors).sort().slice(0, 10).map(d => d.charAt(0).toUpperCase() + d.slice(1));
      // Underexplored grapes: grapes with only one tasting
      const grapeCounts = {};
      tastings.forEach(t => {
        grapeCounts[t.grape] = (grapeCounts[t.grape] || 0) + 1;
      });
      const underexplored = Object.entries(grapeCounts).filter(([g,c]) => c === 1).map(([g]) => g).slice(0,5);
      // Build HTML for insights
      let html = `<div class="panel-header"><div class="panel-title">Insights</div><div class="panel-close" id="insightsClose">✕</div></div>`;
      // Palate map card
      html += `<div class="stats-category-card"><div class="stats-card-title">Your Palate Map</div>`;
      html += `<div class="stat-row"><span class="stat-name">Top Aromas</span><span class="stat-value">${topSmell.join(', ') || '—'}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Top Tastes</span><span class="stat-value">${topTaste.join(', ') || '—'}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Preferred Sweetness</span><span class="stat-value">${prefSweetness}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Preferred Acidity</span><span class="stat-value">${prefAcidity}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Favourite Grapes</span><span class="stat-value">${favouriteGrapes.join(', ') || '—'}</span></div>`;
      html += `</div>`;
      // Blind spots card
      html += `<div class="stats-category-card"><div class="stats-card-title">Your Blind Spots</div>`;
      html += `<div class="stat-row"><span class="stat-name">Descriptors Never Chosen</span><span class="stat-value">${neverSelected.join(', ') || '—'}</span></div>`;
      html += `<div class="stat-row"><span class="stat-name">Underexplored Grapes</span><span class="stat-value">${underexplored.join(', ') || '—'}</span></div>`;
      html += `</div>`;
      showOverlay(html);
      document.getElementById('insightsClose').addEventListener('click', closeOverlay);
    }
  </script>
  <!-- Service worker registration for PWA and persistent storage request -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // register service worker with scope relative to site root
        navigator.serviceWorker.register('service-worker.js', { scope: './' })
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(err) {
            console.error('Service Worker registration failed:', err);
          });
      });
    }
    // Request persistent storage on supporting browsers to maximise data durability
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist().then(function(granted) {
        console.log('Persistent storage granted:', granted);
      });
    }
  </script>
</body>
</html>
